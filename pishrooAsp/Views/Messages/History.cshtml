@model List<pishrooAsp.Models.MessageTemplate.SentMessage>

@{
    ViewData["Title"] = "تاریخچه پیام‌ها";
}

<div class="p-6 space-y-6">

    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold">تاریخچه پیام‌ها</h1>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="bg-green-100 text-green-700 p-3 rounded-lg">
            @TempData["Success"]
        </div>
    }

    <!-- Filters -->
    <form method="get"
          class="grid grid-cols-1 md:grid-cols-5 gap-4 bg-white p-4 rounded-xl shadow">

        <div>
            <label class="text-sm block mb-1">از تاریخ</label>
            <input type="date" name="fromDate"
                   value="@ViewBag.FromDate?.ToString("yyyy-MM-dd")"
                   class="w-full border rounded-lg px-3 py-2" />
        </div>

        <div>
            <label class="text-sm block mb-1">تا تاریخ</label>
            <input type="date" name="toDate"
                   value="@ViewBag.ToDate?.ToString("yyyy-MM-dd")"
                   class="w-full border rounded-lg px-3 py-2" />
        </div>

        <div>
            <label class="text-sm block mb-1">وضعیت</label>
            <select name="status" class="w-full border rounded-lg px-3 py-2">
                <option value="">همه</option>
                <option value="Sent" selected="@(ViewBag.Status == "Sent")">ارسال شده</option>
                <option value="Failed" selected="@(ViewBag.Status == "Failed")">ناموفق</option>
            </select>
        </div>

        <div>
            <label class="text-sm block mb-1">شرکت</label>
            <select name="companyId" class="w-full border rounded-lg px-3 py-2">
                <option value="">همه شرکت‌ها</option>
                @foreach (var c in ViewBag.Companies)
                {
                    <option value="@c.Id" selected="@(ViewBag.CompanyId == c.Id)">
                        @c.Name
                    </option>
                }
            </select>
        </div>

        <div class="flex items-end">
            <button class="w-full bg-gray-800 text-white rounded-lg py-2">
                فیلتر
            </button>
        </div>
    </form>

    <!-- Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow">
        <table class="w-full text-sm text-right">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-3">تاریخ</th>
                    <th class="p-3">شرکت</th>
                    <th class="p-3">قالب</th>
                    <th class="p-3">گیرنده</th>
                    <th class="p-3">نوع</th>
                    <th class="p-3">وضعیت</th>
                    <th class="p-3 text-center">پیام</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr class="border-t hover:bg-gray-50">
                        <td class="p-3 whitespace-nowrap">
                            @item.SentDate.ToString("yyyy/MM/dd HH:mm")
                        </td>

                        <td class="p-3 font-medium">
                            @item.Company?.Name
                        </td>

                        <td class="p-3">
                            @item.Template?.Name
                        </td>

                        <td class="p-3">
                            @item.Recipient
                        </td>

                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-700">
                                @item.MessageType
                            </span>
                        </td>

                        <td class="p-3">
                            @if (item.Status == "Sent")
                            {
                                <span class="text-green-600 font-semibold">ارسال شده</span>
                            }
                            else
                            {
                                <span class="text-red-600 font-semibold">ناموفق</span>
                            }
                        </td>

                        <td class="p-3 text-center">
                            <button onclick="showMessage('@Html.Raw(item.MessageContent.Replace("'", "\\'"))')"
                                    class="text-blue-600 underline text-xs">
                                مشاهده
                            </button>
                        </td>
                    </tr>
                }

                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-500">
                            پیامی یافت نشد
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Message Modal -->
<div id="messageModal"
     class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-xl w-full">
        <h3 class="font-bold mb-3">متن پیام</h3>
        <pre id="messageContent"
             class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"></pre>

        <div class="text-left mt-4">
            <button onclick="closeModal()"
                    class="px-4 py-2 bg-gray-700 text-white rounded-lg">
                بستن
            </button>
        </div>
    </div>
</div>

<script>
    function showMessage(text) {
        document.getElementById('messageContent').innerText = text;
        document.getElementById('messageModal').classList.remove('hidden');
        document.getElementById('messageModal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('messageModal').classList.add('hidden');
        document.getElementById('messageModal').classList.remove('flex');
    }
</script>
